# .ebextensions/06-run-certbot-and-cron.config
# Runs Certbot to obtain the SSL certificate and sets up automatic renewal.
container_commands:
  01_get_certificate:
    command: |
      # Check if certificate already exists to prevent re-running unnecessarily
      if [ ! -d "/etc/letsencrypt/live/forum-backend-env.eba-rkkugpwy.ap-southeast-2.elasticbeanstalk.com" ]; then
        # Use standalone mode for certificate acquisition, stopping Nginx temporarily
        echo "Stopping Nginx for Certbot standalone mode..."
        sudo service nginx stop || true # Use || true to prevent deployment failure if Nginx isn't running
        echo "Running Certbot to obtain certificate..."
        sudo certbot certonly --standalone --non-interactive --agree-tos -m juhyoung.leee@gmail.com -d forum-backend-env.eba-rkkugpwy.ap-southeast-2.elasticbeanstalk.com
        echo "Certbot finished."
      else
        echo "Certificate already exists. Skipping Certbot acquisition."
      fi
    leader_only: true # Important: Only run this command on one instance

files:
  # Add a file to address Nginx types_hash warning
  # This is a general Nginx tuning file, not your main server block config.
  "/etc/nginx/conf.d/nginx_tuning.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      types_hash_max_size 2048;
      types_hash_bucket_size 128;
      server_names_hash_bucket_size 128; # Added for good measure

  "/etc/cron.d/certbot_renew":
    mode: "000644"
    owner: root
    group: root
    content: |
      # This cron job will run Certbot renew twice a day.
      # It will only renew certificates that are due for renewal.
      # The --post-hook will restart Nginx after a successful renewal.
      0 0,12 * * * root /usr/bin/certbot renew --quiet --nginx --post-hook "sudo service nginx restart"
  "/etc/cron.hourly/certbot_renew_check":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # This script provides an hourly check, but the main renewal logic is in cron.d
      /usr/bin/certbot renew --nginx --quiet --post-hook "sudo service nginx restart"
